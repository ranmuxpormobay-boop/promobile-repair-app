<script>
/* === 1) ตั้งค่า URL /exec ของ Apps Script === */
const API = 'https://script.google.com/macros/s/PASTE_YOUR_EXEC_URL_HERE/exec';

/* === 2) Helper & ฟังก์ชันคำนวณ === */
const $ = s => document.querySelector(s);
const form = $('#jobForm');
const money = v => Number(v||0);

function calcTotal(){
  const parts = money(form.parts_cost.value);
  const labor = money(form.labor_cost.value);
  const other = money(form.other_cost.value);
  const total = parts + labor + other;
  $('#grandTotal').textContent = total.toLocaleString();
  return {parts, labor, other, total};
}
['parts_cost','labor_cost','other_cost','deposit'].forEach(n => form[n].addEventListener('input', calcTotal));
calcTotal();

function serializeForm(){
  const o = Object.fromEntries(new FormData(form).entries());
  const n = calcTotal();
  return {
    ...o,
    parts_cost: n.parts,
    labor_cost: n.labor,
    other_cost: n.other,
    deposit: money(o.deposit),
    total: n.total
  };
}
function genJobId(){
  const d = new Date(), p=n=>String(n).padStart(2,'0');
  return `R-${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}-${p(d.getHours())}${p(d.getMinutes())}${p(d.getSeconds())}`;
}

/* === 3) เรียก API === */
async function apiGet(params){
  const r = await fetch(`${API}?${new URLSearchParams(params).toString()}`);
  if(!r.ok) throw new Error('HTTP '+r.status);
  return r.json();
}
async function apiPost(action, data){
  const r = await fetch(API, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({action, data})
  });
  if(!r.ok) throw new Error('HTTP '+r.status);
  return r.json();
}

/* === 4) ประมาณการจากฐาน (แท็บ RepairBaseline) === */
$('#btnEstimate').addEventListener('click', async () => {
  const {brand, model, issue} = serializeForm();
  if(!brand || !model){
    $('#estNote').textContent = 'กรุณากรอก ยี่ห้อ + รุ่น ก่อน';
    return;
  }
  $('#estNote').textContent = 'กำลังดึงฐานราคา...';
  try{
    const res = await apiGet({action:'repairbaseline', brand, model, issue});
    if(res.ok && res.rows && res.rows.length){
      const row = res.rows[0]; // โครงสร้างคอลัมน์ยืดหยุ่น
      const parts = Number(row.parts ?? row.parts_cost ?? row.price_parts ?? row.min ?? 0);
      const labor = Number(row.labor ?? row.labor_cost ?? row.price_labor ?? row.max ?? 0);
      if(parts || labor){
        form.parts_cost.value = parts || 0;
        form.labor_cost.value = labor || 0;
        calcTotal();
      }
      $('#estNote').textContent = row.note || `พบในฐานข้อมูล ${brand} ${model}${issue?` (${issue})`:''}`;
    }else{
      $('#estNote').textContent = 'ไม่พบในฐาน RepairBaseline — กรอกด้วยตนเองได้เลย';
    }
  }catch(e){
    console.error(e);
    $('#estNote').textContent = 'ดึงราคาล้มเหลว: ตรวจสอบ URL /exec และสิทธิ์ Deploy (Anyone)';
  }
});

/* === 5) พิมพ์ใบรับงาน === */
function renderPrint(job){
  const fmt = v => (Number(v||0)).toLocaleString();
  const due = (job.total - (job.deposit||0));
  const html = `
    <div class="text-center font-semibold mb-2">ใบรับงานซ่อม</div>
    <div class="text-xs flex justify-between"><span>เลขที่:</span><span>${job.job_id||'-'}</span></div>
    <div class="text-xs flex justify-between"><span>วันที่:</span><span>${new Date().toLocaleString()}</span></div>
    <hr class="my-2"/>
    <div class="text-sm"><b>ลูกค้า:</b> ${job.customer_name||'-'} | <b>โทร:</b> ${job.customer_phone||'-'}</div>
    <div class="text-sm"><b>เครื่อง:</b> ${job.brand||'-'} ${job.model||''} | <b>IMEI:</b> ${job.imei||'-'}</div>
    <div class="text-sm"><b>อาการ:</b> ${job.issue||'-'}</div>
    <div class="text-sm"><b>อุปกรณ์ที่นำมา:</b> ${job.accessories||'-'}</div>
    <div class="text-sm"><b>รหัสปลดล็อก:</b> ${job.passcode||'-'}</div>
    <div class="mt-2">
      <table class="w-full text-sm">
        <tr><td>ค่าอะไหล่</td><td class="text-right mono">${fmt(job.parts_cost)}</td></tr>
        <tr><td>ค่าแรง</td><td class="text-right mono">${fmt(job.labor_cost)}</td></tr>
        <tr><td>อื่น ๆ</td><td class="text-right mono">${fmt(job.other_cost)}</td></tr>
        <tr><td colspan="2"><hr/></td></tr>
        <tr class="font-bold"><td>รวมสุทธิ</td><td class="text-right mono">${fmt(job.total)}</td></tr>
        <tr><td>มัดจำ</td><td class="text-right mono">- ${fmt(job.deposit)}</td></tr>
        <tr class="font-bold"><td>คงค้าง</td><td class="text-right mono">${fmt(due)}</td></tr>
      </table>
    </div>
    <div class="text-xs mt-3 a5-only">เงื่อนไข: กรุณารับเครื่องภายใน 30 วันหลังแจ้งเสร็จ</div>
  `;
  document.querySelector('#printArea').innerHTML = html;
}

/* === 6) บันทึกใบงาน (POST: createrepair) === */
$('#btnSave').addEventListener('click', async () => {
  const data = serializeForm();
  const job_id = genJobId();
  const payload = {...data, job_id, status:'รับเครื่อง', created_at: new Date().toISOString()};
  try{
    const res = await apiPost('createrepair', payload);
    if(res.ok === false){ throw new Error(res.error||'API error'); }
    localStorage.setItem('lastJobId', res.job_id || job_id);
    alert('บันทึกสำเร็จ ✓ เลขที่งาน: ' + (res.job_id || job_id));
    renderPrint(payload);
  }catch(e){
    console.error(e);
    alert('บันทึกล้มเหลว: ตรวจสอบ URL /exec และสิทธิ์ Deploy (Anyone)\n'+e.message);
  }
});

/* === 7) อัปเดตใบงาน (POST: updaterepair) === */
$('#btnUpdate').addEventListener('click', async (e) => {
  e.preventDefault(); // ป้องกัน submit ฟอร์ม
  const last = localStorage.getItem('lastJobId');
  if(!last){ return alert('ยังไม่มีเลขที่งานล่าสุด ให้กด "บันทึก" ก่อน'); }
  const data = serializeForm();
  const payload = {...data, job_id:last, updated_at:new Date().toISOString()};
  try{
    const res = await apiPost('updaterepair', payload);
    if(res.ok === false){ throw new Error(res.error||'API error'); }
    alert('อัปเดตสำเร็จ ✓ เลขที่งาน: '+ last);
    renderPrint({...payload});
  }catch(e){
    console.error(e);
    alert('อัปเดตล้มเหลว: '+e.message);
  }
});

/* === 8) ปุ่มพิมพ์ตัวอย่าง === */
$('#btnPrint').addEventListener('click', () => {
  const data = serializeForm();
  const job_id = localStorage.getItem('lastJobId') || genJobId();
  renderPrint({...data, job_id});
  window.print();
});
</script>

